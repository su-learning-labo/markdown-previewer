# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰
name: Deploy Markdown Previewer to Xserver

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°
on:
  push:
    branches:
      - main
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹

# å®Ÿè¡Œã•ã‚Œã‚‹ã‚¸ãƒ§ãƒ–ã‚’å®šç¾©
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰
      - name: Build project
        run: npm run build

      # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
      - name: List build artifacts
        run: |
          echo "Build artifacts:"
          ls -la dist/
          echo "Total size:"
          du -sh dist/

      # Xserverã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
      - name: Deploy to Xserver
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "dist/*"
          target: "/home/${{ secrets.SSH_USERNAME }}/i-iide.com/public_html/apps/markdown-previewer/"
          strip_components: 1

      # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å‡¦ç†
      - name: Post-deployment setup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰ã€ã™ãã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åœæ­¢ã™ã‚‹
            
            # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
            cd /home/${{ secrets.SSH_USERNAME }}/i-iide.com/public_html/apps/markdown-previewer
            
            # æ¨©é™ã‚’è¨­å®š
            echo "ğŸ” Setting permissions..."
            chmod -R 755 ./
            
            # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            echo "âœ… Markdown Previewer deployment successful!"
            echo "ğŸŒ Application is now live at: https://i-iide.com/apps/markdown-previewer/"
            
            # ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã‚’è¡¨ç¤º
            echo "ğŸ“Š Deployment info:"
            echo "  - Branch: main"
            echo "  - Commit: ${{ github.sha }}"
            echo "  - Timestamp: $(date)"
            echo "  - Deployed from GitHub Actions"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
            echo "ğŸ“ Deployed files:"
            ls -la

      # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      - name: Health Check
        run: |
          echo "ğŸ” Performing health check..."
          sleep 10 # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…ã¤
          
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if curl -f -s "https://i-iide.com/apps/markdown-previewer/" > /dev/null; then
            echo "âœ… Health check passed! Application is accessible."
          else
            echo "âŒ Health check failed! Application may not be accessible."
            exit 1
          fi

      # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
      - name: Notify deployment success
        if: success()
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“± Markdown Previewer is now live at: https://i-iide.com/apps/markdown-previewer/"
